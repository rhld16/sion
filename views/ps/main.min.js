"use strict";var username,socket,curroom,screen=!1,mainstage="draw",localStream=null,relogin=!1;const videoChat=document.getElementsByClassName("video-container")[0],localVideo=document.getElementById("localVideo");var lastChat,peers=[];function cooldown(){return!(Date.now()-lastChat<1500)}function changeRoom(e){socket.emit("room",curroom,e);for(let e in peers)removePeer(e);curroom=e,document.getElementById("room").innerText="Room: "+curroom,socket.emit("login",username)}createjs.Sound.alternateExtensions=["mp3"],createjs.Sound.registerSound("media/message.mp3","message"),createjs.Sound.registerSound("media/join.mp3","join"),createjs.Sound.registerSound("media/disconnect.mp3","disconnect"),!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&$("#inp").focus(),$("#inp").keypress(function(e){13==e.which&&""!=(username=$("#inp").val())&&loggedin()}),$("form").submit(function(e){e.preventDefault();var t=$("#m").val();if(""!=t&&cooldown()){if(lastChat=Date.now(),/^[\/]/.test(t)){const e=t.slice("/".length).trim().split(/\s+/),o=e.shift().toLowerCase();"rr"==o?socket.emit("rr",e):"clear"==o?socket.emit("clear"):"refresh"==o?socket.emit("refresh"):"room"==o?changeRoom(e[0]):"announce"==o?socket.emit("announce",{message:t,username:username,id:socket.id}):"canvas"==o?"clear"==e[0]?(socket.emit("draw","clear"),clearCanvas()):"game"==e[0]?($("#game").show(),$("#myCanvas").hide(),mainstage="game"):"draw"==e[0]&&($("#game").hide(),$("#myCanvas").show(),mainstage="draw"):"kick"==o&&socket.emit("kick",e[0])}else socket.emit("chat",{message:t,username:username,id:socket.id});$("#m").val("")}}),$("#share").on("click",function(e){e.preventDefault(),0==screen?setScreen():unsetScreen()});var scrollbar=document.getElementById("messages");function loggedin(){$("#preload").hide();new URLSearchParams(window.location.search);navigator.mediaDevices.getUserMedia({video:{width:300},audio:!0}).then(gotLocalMediaStream,handleLocalMediaStreamError)}function gotLocalMediaStream(e){localVideo.onclick=(()=>localVideo.requestPictureInPicture()),localVideo.ontouchstart=(e=>localVideo.requestPictureInPicture()),localVideo.srcObject=localStream=e,init(!0)}function handleLocalMediaStreamError(e){console.log("navigator.getUserMedia error: ",e),localVideo.srcObject=localStream=(()=>{let e=document.createElement("canvas");var t=e.getContext("2d");return t.fillStyle="#000",t.fillRect(0,0,1,150),e.captureStream(25)})(),init(!0)}function mute(){localStream.getAudioTracks().forEach(e=>{e.enabled=!e.enabled,1==e.enabled?$(".my-float").replaceWith("<i class='fas fa-microphone-slash my-float'></i>"):$(".my-float").replaceWith("<i class='fas fa-microphone my-float'></i>")})}function hide(){localStream.getVideoTracks().forEach(e=>{e.enabled=!e.enabled,1==e.enabled?$(".my-floatcam").replaceWith("<i class='fas fa-video-slash my-floatcam'></i>"):$(".my-floatcam").replaceWith("<i class='fas fa-video my-floatcam'></i>")})}function setScreen(){navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0}).then(e=>{for(let t in peers)for(let o in peers[t].streams[0].getTracks())for(let r in e.getTracks())if(peers[t].streams[0].getTracks()[o].kind===e.getTracks()[r].kind){peers[t].replaceTrack(peers[t].streams[0].getTracks()[o],e.getTracks()[r],peers[t].streams[0]),e.getTracks()[r].onended=function(e){unsetScreen()};break}localVideo.srcObject=localStream=e,screen=!0})}function unsetScreen(){navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(e=>{for(let t in peers)for(let o in peers[t].streams[0].getTracks())for(let r in e.getTracks())if(peers[t].streams[0].getTracks()[o].kind===e.getTracks()[r].kind){peers[t].replaceTrack(peers[t].streams[0].getTracks()[o],e.getTracks()[r],peers[t].streams[0]);break}localVideo.srcObject=localStream=e,screen=!1})}function init(e){curroom="lobby",(socket=io()).emit("room","",curroom),document.getElementById("room").innerText="Room: "+curroom,e&&socket.emit("login",username),socket.on("chat",e=>{e.id!=socket.id&&(createjs.Sound.play("message").volume=.2);"rhodri"==e.username.toLowerCase()?$("#messageslist").append(`<li><strong style="color:gold;"><i class="fas fa-crown"></i>${e.username}</strong>: ${e.message}</li>`):$("#messageslist").append(`<li><strong>${e.username}</strong>: ${e.message}</li>`)}),socket.on("announce",e=>{e.id!=socket.id&&(createjs.Sound.play("message").volume=.2);$("#messageslist").append(`<li><strong style="color: red;"><i class="fas fa-bullhorn"></i>${e.username}</strong>: ${e.message}</li>`)}),socket.on("draw",e=>drawStream(e)),socket.on("initReceive",e=>{addPeer(e,!1),socket.emit("initSend",e)}),socket.on("initSend",e=>addPeer(e,!0)),socket.on("removePeer",e=>removePeer(e)),socket.on("disconnect",()=>{for(let e in peers)removePeer(e);e=!0}),window.addEventListener("offline",e=>{createjs.Sound.play("disconnect").volume=.5;for(let e in peers)removePeer(e)}),socket.on("signal",e=>{peers[e.socket_id].signal(e.signal)}),socket.on("gameStateUpdate",e=>updateGameState(e)),socket.on("refresh",()=>{location.reload()}),socket.on("clear",()=>{$("#messageslist").empty()}),socket.on("history",e=>{clearCanvas();for(let t in e)drawStream(e[t])}),socket.on("rr",function(e){var t=document.getElementById("rvideo");if("time"===e[0])return t.currentTime=e[1];if("stop"===e[0])return t.pause(),void $("#rr").hide();if(t.paused){if(e[0])var o=`https://invidious.kavin.rocks/latest_version?id=${e[0]}&itag=22`;else o="media/Rickroll.mp4";t.src=o,t.load(),$("#rr").show(),t.play()}else t.pause(),$("#rr").hide()}),setInterval(nameLoop,2e3),setInterval(gameLoop,30),Mousetrap.bind("shift+x",function(e){e.preventDefault(),mute()}),Mousetrap.bind("shift+z",function(e){e.preventDefault(),hide()})}function removePeer(e){let t=document.getElementById(e),o=document.getElementById(e+"div");t&&(t.srcObject.getTracks().forEach(function(e){e.stop()}),t.srcObject=null,o.parentNode.removeChild(o),t.parentNode.removeChild(t)),peers[e]&&peers[e].destroy(),delete peers[e]}function addPeer(e,t){peers[e]=new SimplePeer({initiator:t,stream:localStream}),peers[e].on("signal",t=>{socket.emit("signal",{signal:t,socket_id:e})}),peers[e].on("stream",t=>{var o=document.createElement("div"),r=document.createElement("video");r.setAttribute("playsinline",""),r.srcObject=t,o.id=e+"div",r.id=e,r.autoplay=!0,r.onclick=(()=>r.requestPictureInPicture()),r.ontouchstart=(e=>r.requestPictureInPicture()),o.appendChild(r),videoChat.appendChild(o),createjs.Sound.play("join").volume=.5})}setInterval(function(){scrollbar.scrollHeight-scrollbar.clientHeight<=scrollbar.scrollTop+30&&(scrollbar.scrollTop=scrollbar.scrollHeight-scrollbar.clientHeight)},250),$("#sizeb").on("click",function(e){e.stopPropagation(),$("#size").toggle()}),$(document.body).on("click",function(){$("#size").hide()});